name: CI

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: 'no'
      upload_release:
        description: 'Upload to Release (create auto release)'
        required: false
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    name: Padavan Build (container)
    runs-on: ubuntu-22.04

    container: registry.gitlab.com/hadzhioglu/padavan-ng

    env:
      build_variant: ${{ matrix.build_variant }}
      targets: ${{ matrix.targets }}
      images_dir: /opt/images

    strategy:
      fail-fast: false
      matrix:
        include:
          # ========================
          # MT7628 Á≥ªÂàó
          # ========================
          - build_variant: "mt7628"
            targets: "MI-3C"

          # ========================
          # MT7621 Á≥ªÂàóÔºàÁ§∫‰æãÔºåÂÖàÊ≥®ÈáäÔºâ
          # ========================
          # - build_variant: "mt7621"
          #   targets: "K2P"

    steps:
      # ============================================================
      # Checkout
      # ============================================================
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================================================
      # 2Ô∏è‚É£ Prepare build environment
      # =========================================================
      # - name: Prepare build environment
      #   run: |
      #     export DEBIAN_FRONTEND=noninteractive
      #     ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
      #     echo "Etc/UTC" > /etc/timezone

      #     apt update
      #     apt install -y tzdata

      #     apt install -y \
      #       unzip libtool-bin curl cmake gperf \
      #       gawk flex bison nano xxd \
      #       fakeroot kmod cpio git python3-docutils \
      #       gettext automake autopoint texinfo build-essential \
      #       help2man pkg-config zlib1g-dev libgmp3-dev libmpc-dev \
      #       libmpfr-dev libncurses5-dev libltdl-dev wget libc-dev-bin \
      #       p7zip-full libtool jq zstd
          
      #     # ‚úÖ ÈÖçÁΩÆ Git safe.directoryÔºåËß£ÂÜ≥ Docker container ‰∏≠ÁöÑÊùÉÈôêÈóÆÈ¢ò
      #     git config --global --add safe.directory '*'

      #     echo "‚úÖ Build environment ready"

      - name: Install Dependencies & Fix Timezone
        run: |
          echo "::group::Apt Update & Install"
          set -x 
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata autoconf autoconf-archive automake autopoint bison build-essential \
          ca-certificates cmake cpio curl dos2unix doxygen fakeroot flex gawk gettext git gperf \
          help2man htop kmod libarchive-tools libblkid-dev libc-ares-dev libcurl4-openssl-dev \
          libdevmapper-dev libev-dev libevent-dev libexif-dev libflac-dev libgmp3-dev \
          libid3tag0-dev libidn2-dev libjpeg-dev libkeyutils-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libogg-dev libsqlite3-dev libssl-dev libsystemd-dev \
          libtool libtool-bin libudev-dev libunbound-dev libvorbis-dev libxml2-dev locales \
          mc nano pkg-config ppp-dev python3 python3-docutils sshpass texinfo unzip uuid \
          uuid-dev vim wget xxd zlib1g-dev jq zip
          set +x
          echo "::endgroup::"

          echo "::group::Timezone Configuration"
          ln -fs /usr/share/zoneinfo/Asia/Taipei /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata
          echo "BUILD_TIME=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          echo "::endgroup::"

      # =========================================================
      # 3Ô∏è‚É£ Prepare Padavan toolchainÔºàÂÖ≥ÈîÆÊ≠•È™§Ôºâ
      # =========================================================
      # - name: Prepare Padavan toolchain
      #   run: |
      #     set -e
      #     cd toolchain-mipsel

      #     echo "üì• Attempting to download prebuilt toolchain..."
      #     # ÂÆâÂÖ®Âú∞Â§ÑÁêÜ Release ‰∏çÂ≠òÂú®ÊàñÊó†ËµÑ‰∫ßÁöÑÊÉÖÂÜµ
      #     ASSET_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
      #       "https://api.github.com/repos/${{ github.repository }}/releases/tags/prebuilt-toolchain-latest" \
      #       | jq -r '(.assets // []) | .[] | select(.name == "prebuilt-toolchain.tar.bz2") | .url')

      #     if [ -n "$ASSET_URL" ]; then
      #       echo "üîç Found prebuilt toolchain, downloading..."
      #       curl -L -H "Accept: application/octet-stream" \
      #            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
      #            -o /tmp/prebuilt-toolchain.tar.bz2 "$ASSET_URL"

      #       echo "üì¶ Extracting prebuilt toolchain..."
      #       tar -xjf /tmp/prebuilt-toolchain.tar.bz2 -C .
      #       rm -f /tmp/prebuilt-toolchain.tar.bz2

      #       echo "‚úÖ Prebuilt toolchain restored successfully, skipping build"
      #     else
      #       echo "üîÑ No prebuilt toolchain available (or Release not found), building from source..."
      #       ./clean_toolchain
      #       ./build_toolchain
      #     fi

      #     echo "‚úÖ Toolchain ready"
      - name: Download prebuilt toolchain
        run: |
          set -e
          cd toolchain-mipsel  # Êàñ‰Ω†ÁöÑÊ∫êÁ†ÅÁõÆÂΩï
          wget -qO- https://gitlab.com/api/v4/projects/hadzhioglu%2Fpadavan-ng/packages/generic/toolchain/latest/toolchain.tzst | tar --zstd -xf -
          if [ ! -e toolchain-3.4.x ]; then
            echo "üîß toolchain-3.4.x not exists, creating symlink"
            ln -s toolchain/out toolchain-3.4.x
          fi

          # ÁîüÊ≠ªÊ†°È™å
          [ -x toolchain-3.4.x/bin/mipsel-linux-uclibc-gcc ] \
            || { echo "‚ùå gcc missing"; exit 1; }

          echo "‚úÖ Toolchain OK"


      # ============================================================
      # Optional tmate debug
      # ============================================================
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event.inputs.debug_enabled == 'yes' }}
        with:
          limit-access-to-actor: true

      # ============================================================
      # Build firmware
      # ============================================================
      - name: Build firmware
        run: |
          set -e
          cd trunk
          mkdir -p ${images_dir}

          echo "Variant: ${build_variant}"
          echo "Targets: ${targets}"

          for m in ${targets}; do
            echo "üî® Building ${m}"
            fakeroot ./build_firmware_ci ${m}
            cp -f images/*.trx ${images_dir}/${m}.trx
            ./clear_tree_simple >/dev/null 2>&1
            echo "‚úÖ ${m} done"
          done

      # ============================================================
      # Package images
      # ============================================================
      - name: Package images
        if: success()
        run: |
          cd ${images_dir}
          GIT_VERSION=$(git rev-parse --short=7 HEAD || echo unknown)
          image_name=images_${build_variant}_${GIT_VERSION}

          md5sum *.trx | tee md5sum.txt
          7z a -mx=9 ${image_name}.7z ./*

          echo "image_name=${image_name}" >> $GITHUB_ENV

      # ============================================================
      # Upload artifact
      # ============================================================
      - name: Upload images to Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.image_name }}
          path: |
            ${{ env.images_dir }}/*.7z
            ${{ env.images_dir }}/*.trx

      # ============================================================
      # Create Release (optional)
      # ============================================================
      - name: Create Release and Upload
        if: github.event.inputs.upload_release == 'yes' && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto Build #${{ github.run_number }}
          body: |
            ü§ñ **Auto Build (Padavan container)**

            - Variant: `${{ matrix.build_variant }}`
            - Targets: `${{ matrix.targets }}`
            - Commit: `${{ github.sha }}`
          files: |
            ${{ env.images_dir }}/*.7z
            ${{ env.images_dir }}/*.trx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # # ============================================================
      # # Delete old prebuilt toolchain release (if exists)
      # # ============================================================
      # - name: Delete old prebuilt toolchain release
      #   if: success()
      #   run: |
      #     set -e
      #     echo "Checking for existing prebuilt-toolchain-latest release..."
      #     RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
      #       "https://api.github.com/repos/${{ github.repository }}/releases/tags/prebuilt-toolchain-latest" \
      #       | jq -r '.id')

      #     if [ "$RELEASE_ID" != "null" ]; then
      #       echo "Deleting old release (ID: $RELEASE_ID)..."
      #       curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
      #         "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
      #     else
      #       echo "No old release to delete"
      #     fi

      # # ============================================================
      # # Package prebuilt toolchain
      # # ============================================================
      # - name: Package prebuilt toolchain
      #   if: success()
      #   run: |
      #     set -e
      #     cd toolchain-mipsel
      #     echo "üì¶ Packaging toolchain..."
      #     tar -cjf ${{ env.images_dir }}/prebuilt-toolchain.tar.bz2 .

      # # ============================================================
      # # Create/Update prebuilt toolchain release
      # # ============================================================
      # - name: Create prebuilt toolchain release
      #   if: success()
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: prebuilt-toolchain-latest
      #     name: Prebuilt Toolchain Latest
      #     body: |
      #       ü§ñ Prebuilt MIPS toolchain for Padavan CI

      #       - Commit: ${{ github.sha }}
      #       - Run: #${{ github.run_number }}
      #       - Date: ${{ steps.vars.outputs.date }}
      #     files: ${{ env.images_dir }}/prebuilt-toolchain.tar.bz2
      #     prerelease: false   # ÂèØÊîπ‰∏∫ true Â¶ÇÊûú‰∏çÊÉ≥ËÆ©ÂÆÉÊòæÁ§∫‰∏∫Ê≠£Âºè release
      #     fail_on_unmatched_files: true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
