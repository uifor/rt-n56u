name: CI

on: 
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: 'no'
      upload_release:
        description: 'Upload to Release (create auto release)'
        required: false
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    name: build
    runs-on: ubuntu-22.04

    env:
      build_variant: ${{ matrix.build_variant }}
      targets: ${{ matrix.targets }}
      images_dir: /opt/images

    strategy:
      matrix:
        include:
          # - build_variant: "mt7621"
          #   targets: "K2P"
          - build_variant: "mt7628"
            targets: "MI-3C"

    steps:
      # ============================================================
      # Checkout
      # ============================================================
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ============================================================
      # Cache APT (optional, best-effort)
      # ============================================================
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-v1
          restore-keys: |
            ${{ runner.os }}-apt-

      # ============================================================
      # Cache Toolchain (FIXED)
      # ============================================================
      - name: Cache Toolchain
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: toolchain-mipsel
          key: ${{ runner.os }}-toolchain-mipsel-${{ matrix.build_variant }}-v3
          restore-keys: |
            ${{ runner.os }}-toolchain-mipsel-${{ matrix.build_variant }}-
            ${{ runner.os }}-toolchain-mipsel-

      # ============================================================
      # Cache build objects (incremental build)
      # ============================================================
      - name: Cache Build Objects
        uses: actions/cache@v4
        with:
          path: |
            trunk/stage
            trunk/romfs
          key: ${{ runner.os }}-build-${{ matrix.build_variant }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.build_variant }}-

      # ============================================================
      # Prepare system environment
      # ============================================================
      - name: Prepare environment
        run: |
          set -e
          export DEBIAN_FRONTEND=noninteractive

          sudo ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
          echo "Etc/UTC" | sudo tee /etc/timezone

          sudo apt update
          sudo apt install -y tzdata

          sudo apt install -y \
            autoconf autoconf-archive automake autopoint \
            bison build-essential ca-certificates cmake \
            cpio curl dos2unix fakeroot flex gawk gettext \
            git gperf help2man kmod libarchive-tools \
            libblkid-dev libc-ares-dev libcurl4-openssl-dev \
            libdevmapper-dev libev-dev libevent-dev \
            libexif-dev libflac-dev libgmp3-dev \
            libid3tag0-dev libidn2-dev libjpeg-dev \
            libkeyutils-dev libltdl-dev libmpc-dev \
            libmpfr-dev libncurses5-dev libogg-dev \
            libsqlite3-dev libssl-dev libsystemd-dev \
            libtool libtool-bin libudev-dev \
            libunbound-dev libvorbis-dev libxml2-dev \
            locales mc nano pkg-config ppp-dev \
            python3 python3-docutils sshpass \
            texinfo unzip uuid uuid-dev vim wget xxd \
            zlib1g-dev

          git config --global --add safe.directory '*'

      # ============================================================
      # Prepare toolchain (CACHE SAFE)
      # ============================================================
      - name: Prepare toolchain
        run: |
          set -e
          cd toolchain-mipsel

          echo "================================================"
          echo "ğŸ” Toolchain cache hit: ${{ steps.cache-toolchain.outputs.cache-hit }}"
          echo "================================================"

          if [ "${{ steps.cache-toolchain.outputs.cache-hit }}" = "true" ]; then
            if ls toolchain-*/bin/*gcc >/dev/null 2>&1; then
              echo "âœ… Toolchain binaries found, skip build"
              ls -lh toolchain-*/bin | head -10
              exit 0
            else
              echo "âš ï¸ Toolchain cache incomplete, rebuild required"
            fi
          fi

          echo "ğŸ”¨ Building toolchain from source..."
          ./clean_toolchain
          ./build_toolchain
          echo "âœ… Toolchain build completed"

      # ============================================================
      # Optional tmate debug
      # ============================================================
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled == 'yes' }}
        with:
          limit-access-to-actor: true

      # ============================================================
      # Build firmware
      # ============================================================
      - name: Start build
        run: |
          set -e
          cd trunk
          sudo mkdir -p ${images_dir}
          sudo chown $USER:$USER ${images_dir}

          echo "================================================"
          echo "ğŸ“¦ Cache Status:"
          echo "   Toolchain cache hit: ${{ steps.cache-toolchain.outputs.cache-hit }}"
          echo "   Build variant: ${{ matrix.build_variant }}"
          echo "   Targets: ${{ matrix.targets }}"
          echo "================================================"

          for m in $targets; do
            echo "ğŸ”¨ Building firmware for $m..."
            fakeroot ./build_firmware_ci $m
            cp -f images/*.trx ${images_dir}/$m.trx
            ./clear_tree_simple >/dev/null 2>&1
            echo "âœ… $m build completed"
          done

      # ============================================================
      # Package images
      # ============================================================
      - name: Create archive
        if: success()
        run: |
          set -e
          ls -lh ${images_dir}

          GIT_VERSION=$(git rev-parse --short=7 HEAD 2>/dev/null || true)

          if [ -n "$GIT_VERSION" ]; then
            image_name=images_${build_variant}_${GIT_VERSION}
          else
            image_name=images_${build_variant}
          fi

          cd ${images_dir}
          md5sum *.trx | tee md5sum.txt
          7z a -mx=9 ${image_name}.7z ./*
          echo "image_name=${image_name}" >> $GITHUB_ENV

      # ============================================================
      # Upload artifact
      # ============================================================
      - name: Upload images to Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.image_name }}
          path: |
            ${{ env.images_dir }}/*.7z
            ${{ env.images_dir }}/*.trx

      # ============================================================
      # Create Release (optional)
      # ============================================================
      - name: Create Release and Upload
        if: github.event.inputs.upload_release == 'yes' && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto Build #${{ github.run_number }}
          body: |
            ğŸ¤– **Auto Build from Manual Trigger**

            - ğŸ·ï¸ Variant: `${{ matrix.build_variant }}`
            - ğŸ¯ Targets: `${{ matrix.targets }}`
            - ğŸ”– Commit: `${{ github.sha }}`
          files: |
            ${{ env.images_dir }}/*.7z
            ${{ env.images_dir }}/*.trx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
